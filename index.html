<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu ƒê·ªÅ Ngh·ªã Y√™u C·∫ßu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            line-height: 1.4;
            color: #000;
            background: #f5f5f5;
            padding: 20px;
            font-size: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border: 1px solid #000;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 8px;
            background: #e6f3ff;
            border: 1px solid #333;
        }

        .header-left, .header-right {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-label {
            font-weight: bold;
            min-width: 80px;
        }

        .info-value {
            padding: 2px 8px;
            background: white;
            border: 1px solid #ccc;
            min-width: 150px;
            min-height: 20px;
        }

        .content-section {
            margin-bottom: 15px;
            padding: 8px;
            background: #e6f3ff;
            border: 1px solid #333;
        }

        .content-row {
            display: flex;
            gap: 20px;
            margin-bottom: 8px;
        }

        .content-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .content-label {
            font-weight: bold;
            white-space: nowrap;
        }

        .content-value {
            padding: 4px 8px;
            background: white;
            border: 1px solid #ccc;
            min-height: 25px;
            flex: 1;
        }

        .content-value.large {
            min-height: 60px;
            align-items: flex-start;
            padding-top: 8px;
        }

        .table-container {
            margin-bottom: 20px;
            border: 2px solid #000;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .main-table th, .main-table td {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
            vertical-align: middle;
        }

        .main-table th {
            background: #d0e4f7;
            font-weight: bold;
            font-size: 10px;
        }

        .main-table .stt-col { width: 30px; }
        .main-table .mavat-col { width: 60px; }
        .main-table .ten-col { width: 120px; }
        .main-table .dvt-col { width: 40px; }
        .main-table .quy-cach-col { width: 80px; }
        .main-table .hang-col { width: 60px; }
        .main-table .thongso-col { width: 80px; }
        .main-table .khoiluong-col { width: 70px; }
        .main-table .tongkhoi-col { width: 70px; }
        .main-table .soluong-col { width: 60px; }
        .main-table .denhoi-col { width: 70px; }
        .main-table .conlai-col { width: 70px; }
        .main-table .ngaycau-col { width: 80px; }
        .main-table .nhacung-col { width: 100px; }
        .main-table .ghichu-col { width: 100px; }

        .table-row {
            height: 35px;
        }

        .editable {
            background: white;
            min-height: 25px;
            padding: 2px;
            border: none;
            width: 100%;
            text-align: center;
        }

        .buttons {
            margin-top: 30px;
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            margin: 0 8px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .signature-section {
            margin-top: 30px;
            text-align: right;
            font-style: italic;
        }

        @media print {
            body {
                background: white;
                padding: 0;
                font-size: 11px;
            }
            
            .container {
                padding: 10px;
                border: none;
            }
            
            .buttons {
                display: none;
            }
        }

        .no-data {
            color: #999;
            font-style: italic;
        }

        .row-controls {
            display: inline-block;
            margin-left: 10px;
        }

        .add-row-btn, .remove-row-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin: 0 2px;
        }

        .remove-row-btn {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Information -->
        <div class="header-info">
            <div class="header-left">
                <div class="info-row">
                    <span class="info-label">M√£ d·ª± √°n:</span>
                    <div class="info-value" id="duAn">D·ª± √°n</div>
                </div>
                <div class="info-row">
                    <span class="info-label">H·ªá th·ªëng:</span>
                    <div class="info-value" id="heThong">H·ªá th·ªëng</div>
                </div>
            </div>
            <div class="header-right">
                <div class="info-row">
                    <span class="info-label">S·ªë YCVT:</span>
                    <div class="info-value" id="soPhieu">S·ªë phi·∫øu</div>
                </div>
                <div class="info-row">
                    <span class="info-label">Ng∆∞·ªùi ƒë·ªÅ ngh·ªã:</span>
                    <div class="info-value" id="nguoiDeXuat">Ng∆∞·ªùi ƒë·ªÅ xu·∫•t</div>
                    <span style="margin-left: 20px;"><strong>Ch·ª©c v·ª•:</strong> Ch·ªâ huy tr∆∞·ªüng</span>
                </div>
            </div>
        </div>

        <!-- Content Section -->
        <div class="content-section">
            <div class="content-row">
                <div class="content-item" style="flex: 2;">
                    <span class="content-label">N·ªôi dung ƒë·ªÅ xu·∫•t:</span>
                    <div class="content-value large" id="noiDungDeXuat">N·ªôi dung ƒë·ªÅ xu·∫•t</div>
                </div>
                <div class="content-item" style="flex: 1;">
                    <span class="content-label">Ng√†y ƒë·ªÅ xu·∫•t:</span>
                    <div class="content-value" id="ngayDeXuat">Ng√†y ƒë·ªÅ xu·∫•t</div>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div class="table-container">
            <table class="main-table">
                <thead>
                    <tr>
                        <th rowspan="2" class="stt-col">STT</th>
                        <th rowspan="2" class="mavat-col">M√£ v·∫≠t t∆∞</th>
                        <th rowspan="2" class="ten-col">T√™n v·∫≠t t∆∞, thi·∫øt b·ªã</th>
                        <th rowspan="2" class="dvt-col">ƒêVT</th>
                        <th rowspan="2" class="quy-cach-col">Quy c√°ch, M√£ hi·ªáu</th>
                        <th rowspan="2" class="hang-col">H√£ng/ xu·∫•t x·ª©</th>
                        <th rowspan="2" class="thongso-col">Th√¥ng s·ªë k·ªπ thu·∫≠t</th>
                        <th rowspan="2" class="khoiluong-col">Kh·ªëi l∆∞·ª£ng h·ª£p ƒë·ªìng</th>
                        <th rowspan="2" class="tongkhoi-col">T·ªïng kh·ªëi l∆∞·ª£ng d·ª± ki·∫øn</th>
                        <th rowspan="2" class="soluong-col">S·ªë l∆∞·ª£ng l≈©y k·∫ø ƒë√£ c·∫•p</th>
                        <th rowspan="2" class="denhoi-col">SL ƒë·ªÅ ngh·ªã ƒë·ª£t n√†y</th>
                        <th rowspan="2" class="conlai-col">S·ªë l∆∞·ª£ng c√≤n l·∫°i</th>
                        <th rowspan="2" class="ngaycau-col">Ng√†y y√™u c·∫ßu c·∫•p</th>
                        <th rowspan="2" class="nhacung-col">Nh√† cung c·∫•p</th>
                        <th rowspan="2" class="ghichu-col">Ghi ch√∫</th>
                    </tr>
                    <tr>
                        <th style="font-size: 9px; font-style: italic;">&lt;&lt;Start Select (CT_YCVT [ID], [S·ªë phi·∫øu])&gt;&gt; &lt;&lt;[Thi·∫øt k·∫øt]&gt;&gt; &lt;&lt;[S·ªë phi·∫øu])&gt;&gt;</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows s·∫Ω ƒë∆∞·ª£c generate b·ªüi JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Buttons -->
        <div class="buttons">
            <button class="btn" onclick="printForm()">üñ®Ô∏è In phi·∫øu</button>
            <button class="btn secondary" onclick="exportToPDF()">üìÑ Xu·∫•t PDF</button>
            <button class="btn secondary" onclick="fillSampleData()">üìù D·ªØ li·ªáu m·∫´u</button>
            <button class="btn secondary" onclick="addTableRow()">‚ûï Th√™m d√≤ng</button>
            <button class="btn secondary" onclick="clearAllData()">üóëÔ∏è X√≥a d·ªØ li·ªáu</button>
        </div>

        <!-- Signature -->
        <div class="signature-section">
            <p>Ng√†y ... th√°ng ... nƒÉm 2024</p>
            <p><strong>Ng∆∞·ªùi l·∫≠p phi·∫øu</strong></p>
            <br><br>
            <p>(K√Ω t√™n v√† ghi r√µ h·ªç t√™n)</p>
        </div>
    </div>

    <script>
        let tableData = [];

        // H√†m l·∫•y parameters t·ª´ URL
        function getURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};
            
            const paramNames = [
                'soPhieu', 'duAn', 'heThong', 'noiDungDeXuat', 
                'nguoiDeXuat', 'ngayDeXuat', 'ghiChu', 'tableData'
            ];
            
            paramNames.forEach(param => {
                const value = urlParams.get(param);
                params[param] = value ? decodeURIComponent(value) : null;
            });
            
            // L·∫•y d·ªØ li·ªáu b·∫£ng theo format item1_, item2_, ... t·ª´ AppSheet
            const tableItems = [];
            let itemIndex = 1;
            
            while (urlParams.has(`item${itemIndex}_maVatTu`) || urlParams.has(`item${itemIndex}_tenVatTu`)) {
                const item = {
                    stt: itemIndex,
                    maVatTu: decodeURIComponent(urlParams.get(`item${itemIndex}_maVatTu`) || ''),
                    tenVatTu: decodeURIComponent(urlParams.get(`item${itemIndex}_tenVatTu`) || ''),
                    dvt: decodeURIComponent(urlParams.get(`item${itemIndex}_dvt`) || ''),
                    quyCach: decodeURIComponent(urlParams.get(`item${itemIndex}_quyCach`) || ''),
                    hangXuatXu: decodeURIComponent(urlParams.get(`item${itemIndex}_hangXuatXu`) || ''),
                    thongSoKyThuat: decodeURIComponent(urlParams.get(`item${itemIndex}_thongSoKyThuat`) || ''),
                    khoiLuongHopDong: urlParams.get(`item${itemIndex}_khoiLuongHopDong`) || '',
                    tongKhoiLuong: urlParams.get(`item${itemIndex}_tongKhoiLuong`) || '',
                    soLuongLuyKe: urlParams.get(`item${itemIndex}_soLuongLuyKe`) || '',
                    slDeNghi: urlParams.get(`item${itemIndex}_slDeNghi`) || '',
                    soLuongConLai: urlParams.get(`item${itemIndex}_soLuongConLai`) || '',
                    ngayYeuCau: urlParams.get(`item${itemIndex}_ngayYeuCau`) || '',
                    nhaCungCap: decodeURIComponent(urlParams.get(`item${itemIndex}_nhaCungCap`) || ''),
                    ghiChu: decodeURIComponent(urlParams.get(`item${itemIndex}_ghiChu`) || '')
                };
                
                // Ch·ªâ th√™m item n·∫øu c√≥ √≠t nh·∫•t m√£ v·∫≠t t∆∞ ho·∫∑c t√™n v·∫≠t t∆∞
                if (item.maVatTu || item.tenVatTu) {
                    tableItems.push(item);
                }
                itemIndex++;
                
                // Gi·ªõi h·∫°n t·ªëi ƒëa 20 items ƒë·ªÉ tr√°nh v√≤ng l·∫∑p v√¥ h·∫°n
                if (itemIndex > 20) break;
            }
            
            if (tableItems.length > 0) {
                params.tableItems = tableItems;
            }
            
            return params;
        }

        // H√†m ƒëi·ªÅn d·ªØ li·ªáu c∆° b·∫£n v√†o form
        function populateForm(data) {
            const basicFields = ['soPhieu', 'duAn', 'heThong', 'noiDungDeXuat', 'nguoiDeXuat', 'ngayDeXuat'];
            
            basicFields.forEach(field => {
                const element = document.getElementById(field);
                if (element && data[field]) {
                    element.textContent = data[field];
                }
            });

            // Format ng√†y ƒë·ªÅ xu·∫•t
            if (data.ngayDeXuat) {
                const ngayElement = document.getElementById('ngayDeXuat');
                try {
                    const date = new Date(data.ngayDeXuat);
                    if (!isNaN(date.getTime())) {
                        ngayElement.textContent = date.toLocaleDateString('vi-VN', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                    } else {
                        ngayElement.textContent = data.ngayDeXuat;
                    }
                } catch (e) {
                    ngayElement.textContent = data.ngayDeXuat;
                }
            }

            // X·ª≠ l√Ω d·ªØ li·ªáu b·∫£ng t·ª´ JSON
            if (data.tableData) {
                try {
                    tableData = JSON.parse(data.tableData);
                    // ƒê·∫£m b·∫£o c√≥ STT
                    tableData.forEach((item, index) => {
                        item.stt = index + 1;
                    });
                    renderTable();
                } catch (e) {
                    console.error('L·ªói parse d·ªØ li·ªáu b·∫£ng JSON:', e);
                }
            }
            
            // X·ª≠ l√Ω d·ªØ li·ªáu b·∫£ng t·ª´ parameters ri√™ng l·∫ª (t·ª´ AppSheet)
            if (data.tableItems && data.tableItems.length > 0) {
                tableData = data.tableItems;
                renderTable();
                console.log('ƒê√£ load d·ªØ li·ªáu t·ª´ AppSheet:', data.tableItems.length + ' items');
            }
        }

        // H√†m t·∫°o d√≤ng tr·ªëng cho b·∫£ng
        function createEmptyRow(index) {
            return {
                stt: index + 1,
                maVatTu: '',
                tenVatTu: '',
                dvt: '',
                quyCach: '',
                hangXuatXu: '',
                thongSoKyThuat: '',
                khoiLuongHopDong: '',
                tongKhoiLuong: '',
                soLuongLuyKe: '',
                slDeNghi: '',
                soLuongConLai: '',
                ngayYeuCau: '',
                nhaCungCap: '',
                ghiChu: ''
            };
        }

        // H√†m render b·∫£ng
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (tableData.length === 0) {
                // T·∫°o 10 d√≤ng tr·ªëng m·∫∑c ƒë·ªãnh
                for (let i = 0; i < 10; i++) {
                    tableData.push(createEmptyRow(i));
                }
            }

            tableData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'table-row';
                tr.innerHTML = `
                    <td>${row.stt}</td>
                    <td><input type="text" class="editable" value="${row.maVatTu}" onchange="updateTableData(${index}, 'maVatTu', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.tenVatTu}" onchange="updateTableData(${index}, 'tenVatTu', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.dvt}" onchange="updateTableData(${index}, 'dvt', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.quyCach}" onchange="updateTableData(${index}, 'quyCach', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.hangXuatXu}" onchange="updateTableData(${index}, 'hangXuatXu', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.thongSoKyThuat}" onchange="updateTableData(${index}, 'thongSoKyThuat', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.khoiLuongHopDong}" onchange="updateTableData(${index}, 'khoiLuongHopDong', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.tongKhoiLuong}" onchange="updateTableData(${index}, 'tongKhoiLuong', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.soLuongLuyKe}" onchange="updateTableData(${index}, 'soLuongLuyKe', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.slDeNghi}" onchange="updateTableData(${index}, 'slDeNghi', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.soLuongConLai}" onchange="updateTableData(${index}, 'soLuongConLai', this.value)"></td>
                    <td><input type="date" class="editable" value="${row.ngayYeuCau}" onchange="updateTableData(${index}, 'ngayYeuCau', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.nhaCungCap}" onchange="updateTableData(${index}, 'nhaCungCap', this.value)"></td>
                    <td><input type="text" class="editable" value="${row.ghiChu}" onchange="updateTableData(${index}, 'ghiChu', this.value)"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu b·∫£ng
        function updateTableData(index, field, value) {
            if (tableData[index]) {
                tableData[index][field] = value;
            }
        }

        // H√†m th√™m d√≤ng m·ªõi
        function addTableRow() {
            const newIndex = tableData.length;
            tableData.push(createEmptyRow(newIndex));
            renderTable();
        }

        // H√†m x√≥a t·∫•t c·∫£ d·ªØ li·ªáu
        function clearAllData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu?')) {
                tableData = [];
                renderTable();
                
                // Clear basic fields
                ['soPhieu', 'duAn', 'heThong', 'noiDungDeXuat', 'nguoiDeXuat', 'ngayDeXuat'].forEach(field => {
                    const element = document.getElementById(field);
                    if (element) {
                        element.textContent = field.charAt(0).toUpperCase() + field.slice(1);
                    }
                });
            }
        }

        // H√†m ƒëi·ªÅn d·ªØ li·ªáu m·∫´u
        function fillSampleData() {
            const sampleBasicData = {
                soPhieu: 'YCVT-2024-001',
                duAn: 'D·ª± √°n ERP System',
                heThong: 'H·ªá th·ªëng qu·∫£n l√Ω',
                noiDungDeXuat: 'ƒê·ªÅ xu·∫•t mua s·∫Øm thi·∫øt b·ªã v√† ph·∫ßn m·ªÅm cho h·ªá th·ªëng qu·∫£n l√Ω kho',
                nguoiDeXuat: 'Nguy·ªÖn VƒÉn A',
                ngayDeXuat: '15/08/2024'
            };

            populateForm(sampleBasicData);

            // Sample table data theo format AppSheet
            tableData = [
                {
                    stt: 1,
                    maVatTu: 'MT001',
                    tenVatTu: 'M√°y t√≠nh Dell OptiPlex 7090',
                    dvt: 'B·ªô',
                    quyCach: '7090 MT, i5-10500',
                    hangXuatXu: 'Dell/USA',
                    thongSoKyThuat: 'i5-10500, 8GB RAM, 256GB SSD',
                    khoiLuongHopDong: '10',
                    tongKhoiLuong: '10',
                    soLuongLuyKe: '5',
                    slDeNghi: '3',
                    soLuongConLai: '2',
                    ngayYeuCau: '2024-09-01',
                    nhaCungCap: 'C√¥ng ty ABC',
                    ghiChu: 'C·∫•p g·∫•p'
                },
                {
                    stt: 2,
                    maVatTu: 'MT002',
                    tenVatTu: 'License Windows 11 Pro',
                    dvt: 'License',
                    quyCach: 'FQC-10528',
                    hangXuatXu: 'Microsoft/USA',
                    thongSoKyThuat: 'Windows 11 Professional 64-bit',
                    khoiLuongHopDong: '10',
                    tongKhoiLuong: '10',
                    soLuongLuyKe: '5',
                    slDeNghi: '3',
                    soLuongConLai: '2',
                    ngayYeuCau: '2024-09-01',
                    nhaCungCap: 'C√¥ng ty XYZ',
                    ghiChu: 'B·∫£n quy·ªÅn ch√≠nh h√£ng'
                }
            ];

            // Th√™m 8 d√≤ng tr·ªëng n·ªØa
            for (let i = 2; i < 10; i++) {
                tableData.push(createEmptyRow(i));
            }

            renderTable();
        }

        // H√†m in form
        function printForm() {
            window.print();
        }

        // H√†m xu·∫•t PDF
        function exportToPDF() {
            const printWindow = window.open('', '_blank');
            const content = document.documentElement.outerHTML;
            
            printWindow.document.write(content);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c load
        document.addEventListener('DOMContentLoaded', function() {
            const urlData = getURLParameters();
            populateForm(urlData);
            
            if (tableData.length === 0) {
                renderTable(); // T·∫°o b·∫£ng tr·ªëng m·∫∑c ƒë·ªãnh
            }
        });

        // Export function ƒë·ªÉ t·∫°o URL v·ªõi d·ªØ li·ªáu
        function createFormURL(baseURL, basicData, tableData) {
            const url = new URL(baseURL);
            
            // Th√™m d·ªØ li·ªáu c∆° b·∫£n
            Object.keys(basicData).forEach(key => {
                if (basicData[key]) {
                    url.searchParams.set(key, encodeURIComponent(basicData[key]));
                }
            });
            
            // Th√™m d·ªØ li·ªáu b·∫£ng
            if (tableData && tableData.length > 0) {
                url.searchParams.set('tableData', encodeURIComponent(JSON.stringify(tableData)));
            }
            
            return url.toString();
        }

        window.createFormURL = createFormURL;
    </script>
</body>
</html>
